name: AnalyzeBest-è¾¾æ ‡ç»„åˆæ± æ£€éªŒ-è‡ªæ‰˜ç®¡

on:
  workflow_dispatch:
    inputs:
      lottery_type:
        description: 'é€‰æ‹©å½©ç§ç±»å‹'
        required: true
        default: 'p5'
        type: choice
        options:
          - p5
          - 3d
          - all

permissions:
  contents: write

jobs:
  analyze_best:
    name: Analyze best tasks for ${{ inputs.lottery_type }}
    runs-on: [self-hosted, ARM64]
    env:
      MYSQL_HOST: 127.0.0.1
      MYSQL_PORT: 3306
      MYSQL_USER: root
      MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
      MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
      BACKUP_PASSWORD: ${{ secrets.BACKUP_PASSWORD }}
      GH_TOKEN: ${{ secrets.PERSONAL_GH_PAT }}
      GITHUB_RUN_NUMBER: ${{ github.run_number }}
      WECHAT_API_URL: ${{ secrets.WECHAT_API_URL }}
      WECHAT_API_KEY: ${{ secrets.WECHAT_API_KEY }}
      EXPORT_DIR: best_tasks_export
    steps:
      - name: ğŸ•’ æ‰“å°æ—¶é—´ï¼ˆUTC + Asia/Shanghaiï¼‰
        run: |
          echo "==== ğŸ•’ å½“å‰æ—¶é—´ ===="
          echo "UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "Asia/Shanghai: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "====================="

      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ³ å¯åŠ¨ MySQL å®¹å™¨
        run: |
          docker run -d \
            --name mysql-service-${{ github.run_id }} \
            -e MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_PASSWORD }} \
            -e MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }} \
            -p 3306:3306 \
            --health-cmd="mysqladmin ping -h 127.0.0.1 --silent" \
            --health-interval=10s \
            --health-timeout=5s \
            --health-retries=30 \
            mysql:8.0.36

      - name: ğŸ•“ ç­‰å¾… MySQL å®¹å™¨å˜ä¸º healthy
        run: |
          CONTAINER=mysql-service-${{ github.run_id }}
          echo "ç­‰å¾…å®¹å™¨ $CONTAINER å˜ä¸º healthy ..."
          
          for i in {1..30}; do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' "$CONTAINER" 2>/dev/null || echo "notfound")
          
            if [[ "$STATUS" == "healthy" ]]; then
              echo "âœ… MySQL å®¹å™¨å¥åº· âœ”ï¸"
              exit 0
            elif [[ "$STATUS" == "unhealthy" ]]; then
              echo "âŒ MySQL å®¹å™¨ unhealthy â—"
              docker logs "$CONTAINER"
              exit 1
            elif [[ "$STATUS" == "notfound" ]]; then
              echo "â³ å®¹å™¨å°šæœªåˆ›å»ºå¥½ ($i)..."
            else
              echo "â³ å½“å‰çŠ¶æ€ï¼š$STATUS ($i)..."
            fi
            sleep 2
          done
          
          echo "âŒ è¶…æ—¶ï¼šå®¹å™¨ 30 ç§’å†…æœªå˜ä¸º healthy"
          docker logs "$CONTAINER"
          exit 1

      - name: ğŸ“¦ ğŸ› ï¸ åˆå§‹åŒ– best_tasks è¾¾æ ‡ç»„åˆè¡¨ï¼ˆæ”¯æŒ P5 / 3Dï¼‰
        run: |
          echo "=============================="
          echo "ğŸ¯ å¼€å§‹æ‰§è¡Œ best_tasks_ok è¡¨å¯¼å…¥å·¥ä½œæµ"
          echo "â± å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "=============================="
          START_TIME=$(date +%s)
          
          echo "ğŸ“ åˆ›å»ºç›®å½• & ä¸‹è½½ ZIP"
          mkdir -p data
          curl -L -o data/best_tasks_ok.zip \
            https://github.com/suwei8/LottoAI3_HitMatrix/releases/download/ok/best_tasks_ok.sql.zip
          
          echo "ğŸ”“ è§£å‹ ZIP"
          sudo apt-get update && sudo apt-get install -y unzip pv
          unzip -P ${{ secrets.BACKUP_PASSWORD }} -d data/ data/best_tasks_ok.zip
          
          echo "ğŸš€ æ¢å¤æ•°æ®åº“ï¼ˆæ˜¾ç¤ºå¯¼å…¥è¿›åº¦ï¼‰"
          pv data/best_tasks_ok.sql | \
            mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD $MYSQL_DATABASE
          
          echo "âœ… æ£€æŸ¥å¯¼å…¥ç»“æœï¼šæ‰“å°å‰5æ¡è®°å½•"
          
          echo "ğŸ“„ è¡¨ï¼šbest_tasks_3dï¼ˆå‰5è¡Œï¼‰"
          mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD $MYSQL_DATABASE \
            -e "SELECT * FROM best_tasks_3d LIMIT 5;"
          
          echo "ğŸ“„ è¡¨ï¼šbest_tasks_p5ï¼ˆå‰5è¡Œï¼‰"
          mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD $MYSQL_DATABASE \
            -e "SELECT * FROM best_tasks_p5 LIMIT 5;"
          
          echo "ğŸ§¹ æ¸…ç†ä¸­é—´æ–‡ä»¶"
          rm -rf data/*
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "=============================="
          echo "âœ… æ‰§è¡Œå®Œæ¯•ï¼šè€—æ—¶ ${DURATION} ç§’ï¼ˆçº¦ $((DURATION / 60)) åˆ†é’Ÿï¼‰"
          echo "â± ç»“æŸæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "=============================="

#      - name: ğŸ“¦ ä¸‹è½½å¹¶è¿˜åŸæœ€è¿‘30æœŸé¢„æµ‹æ•°æ®å¤‡ä»½ï¼ˆæ”¯æŒ P5/3D/allï¼‰
#        run: |
#          restore_data() {
#            local lottery=$1
#            if [ "$lottery" = "3d" ]; then
#              REPO="LottoAI3_HitMatrix_date_3d"
#            else
#              REPO="LottoAI3_HitMatrix_date"
#            fi
#
#            echo "=============================="
#            echo "ğŸ¯ å¼€å§‹æ‰§è¡Œ Download $lottery é¢„æµ‹æ•°æ®å¤‡ä»½"
#            echo "â± å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
#            echo "=============================="
#            START_TIME=$(date +%s)
#
#            mkdir -p data
#
#            echo "ğŸ“¥ ä¸‹è½½æ¥è‡ªä»“åº“ï¼š$REPO"
#            curl -L -o data/lotto_${lottery}_backup.zip \
#              https://github.com/suwei8/${REPO}/releases/download/backup-${lottery}/lotto_${lottery}_backup.zip
#
#            echo "ğŸ”“ è§£å‹ ZIP"
#            sudo apt-get update && sudo apt-get install -y unzip pv
#            unzip -P ${{ secrets.BACKUP_PASSWORD }} -d data/ data/lotto_${lottery}_backup.zip
#
#            echo "ğŸš€ æ¢å¤æ•°æ®åº“ï¼ˆæ˜¾ç¤ºå¯¼å…¥è¿›åº¦ï¼‰"
#            gunzip -c data/lotto_${lottery}.sql.gz | \
#              pv -s $(gzip -l data/lotto_${lottery}.sql.gz | awk 'NR==2 {print $2}') | \
#              mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD $MYSQL_DATABASE
#
#            echo "ğŸ§¹ æ¸…ç†ä¸­é—´æ–‡ä»¶"
#            rm -rf data/*
#
#            END_TIME=$(date +%s)
#            DURATION=$((END_TIME - START_TIME))
#            echo "=============================="
#            echo "âœ… $lottery æ‰§è¡Œå®Œæ¯•ï¼šè€—æ—¶ ${DURATION} ç§’ï¼ˆçº¦ $((DURATION / 60)) åˆ†é’Ÿï¼‰"
#            echo "â± ç»“æŸæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
#            echo "=============================="
#          }
#
#          if [[ "${{ inputs.lottery_type }}" == "3d" ]]; then
#            restore_data 3d
#          elif [[ "${{ inputs.lottery_type }}" == "p5" ]]; then
#            restore_data p5
#          elif [[ "${{ inputs.lottery_type }}" == "all" ]]; then
#            restore_data 3d
#            restore_data p5
#          else
#            echo "âŒ æ— æ•ˆ lottery_type: ${{ inputs.lottery_type }}"
#            exit 1
#          fi

#      - name: ğŸ å®‰è£… Python ä¾èµ–
#        uses: actions/setup-python@v5
#        with:
#          python-version: '3.11'
#
#      - name: ğŸ“¦ å®‰è£… requirements.txt
#        run: |
#          python -m pip install --upgrade pip
#          pip install -r requirements.txt


#      - name: ğŸ“Š åˆ†æè¾¾æ ‡ä»»åŠ¡ï¼ˆå…¨éƒ¨åˆ†ä½ä¸²è¡Œå¤„ç†ï¼‰
#        run: |
#          LOTTERY=${{ inputs.lottery_type }}
#
#          run_analysis() {
#            local lottery=$1
#            local max_pos=$2
#            echo "===== ğŸ¯ åˆ†æ $lottery ====="
#            for pos in $(seq 0 $max_pos); do
#              echo "â¡ï¸ åˆ†æ $lottery - åˆ†ä½ $pos"
#              python scripts/analyze_best_tasks.py $lottery $pos
#            done
#          }
#
#          if [[ "$LOTTERY" == "3d" ]]; then
#            run_analysis 3d 2
#          elif [[ "$LOTTERY" == "p5" ]]; then
#            run_analysis p5 4
#          elif [[ "$LOTTERY" == "all" ]]; then
#            run_analysis 3d 2
#            run_analysis p5 4
#          else
#            echo "âŒ æœªçŸ¥å½©ç§ç±»å‹: $LOTTERY"
#            exit 1
#          fi

      - name: â¬†ï¸ å¯¼å‡º best_tasks_3d / p5 å¹¶ä¸Šä¼ è‡³ Releases
        run: |
          echo "ğŸ“ åˆ›å»ºå¯¼å‡ºç›®å½•"
          mkdir -p best_tasks_export

          echo "ğŸ“¦ å¯¼å‡º SQL è¡¨..."
          mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD \
            $MYSQL_DATABASE best_tasks_3d best_tasks_p5 > best_tasks_export/best_tasks_ok.sql

          echo "ğŸ” å®‰è£… zip å·¥å…·å¹¶å‹ç¼©ï¼ˆå¯†ç ä¿æŠ¤ï¼‰"
          sudo apt-get update && sudo apt-get install -y zip
          cd best_tasks_export
          zip -P "$BACKUP_PASSWORD" best_tasks_ok.sql.zip best_tasks_ok.sql
          cd ..

          echo "ğŸš€ ä¸Šä¼  ZIP åˆ° GitHub Releases âœ tag=ok"
          gh release upload ok best_tasks_export/best_tasks_ok.sql.zip --clobber

          echo "âœ… å®Œæˆå¯¼å‡ºä¸ä¸Šä¼  ğŸ‰"

      - name: ğŸ§¹ æ¸…ç† MySQL å®¹å™¨
        if: always()
        run: |
          docker rm -f mysql-service-${{ github.run_id }} || true
